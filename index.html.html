<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#040403">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Carlitos">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Contale a Carlitos</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #070605;
  --card: #0f0e0c;
  --card2: #141210;
  --border: #1e1c18;
  --border2: #2a2620;
  --gold: #b89a5c;
  --gold2: #7a6438;
  --gold3: #b89a5c1a;
  --text: #e0d8c8;
  --text2: #9a9080;
  --text3: #504840;
  --red: #8b3a2a;
  --green: #3a6a4a;
  --blue: #2a4a6a;
}

* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Cormorant Garamond', serif;
  font-size: 18px;
  line-height: 1.65;
  min-height: 100vh;
}

/* grain */
body::after {
  content:'';
  position:fixed; inset:0;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
  pointer-events:none; z-index:9999;
}

.app { max-width:800px; margin:0 auto; padding:0 24px 120px; }

/* â”€â”€ HEADER â”€â”€ */
header {
  padding: 64px 0 48px;
  border-bottom: 1px solid var(--border2);
  margin-bottom: 0;
  position: relative;
}

.logo-row { display:flex; align-items:baseline; gap:16px; margin-bottom:8px; }

.logo {
  font-family:'Cormorant Garamond', serif;
  font-size:48px; font-weight:300;
  letter-spacing:-1px; color:var(--text);
  line-height:1;
}

.logo em { font-style:italic; color:var(--gold); }

.pro-badge {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; letter-spacing:3px;
  color:var(--bg); background:var(--gold);
  padding:3px 8px; text-transform:uppercase;
  display:none;
}

.pro-badge.visible { display:inline; }

.tagline {
  font-family:'JetBrains Mono', monospace;
  font-size:10px; color:var(--text3);
  letter-spacing:2px;
}

.tagline em { color:var(--gold); font-style:normal; }

/* â”€â”€ STATS â”€â”€ */
.stats {
  display:flex; gap:1px;
  background:var(--border);
  margin: 36px 0;
}

.stat {
  flex:1; background:var(--card);
  padding:18px 16px; text-align:center;
}

.stat-n {
  font-family:'Cormorant Garamond', serif;
  font-size:32px; font-weight:300;
  color:var(--gold); line-height:1;
  margin-bottom:5px;
}

.stat-l {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; color:var(--text3);
  letter-spacing:2px; text-transform:uppercase;
}

/* â”€â”€ NAV â”€â”€ */
.nav {
  display:flex; gap:0;
  border-bottom:1px solid var(--border2);
  margin-bottom:36px;
  overflow-x:auto;
}

.nav::-webkit-scrollbar { display:none; }

.nav-tab {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text3); padding:11px 18px;
  cursor:pointer; border:none; background:none;
  border-bottom:2px solid transparent;
  margin-bottom:-1px; white-space:nowrap;
  transition:all 0.2s; display:flex;
  align-items:center; gap:7px;
}

.nav-tab:hover { color:var(--text2); }
.nav-tab.active { color:var(--gold); border-bottom-color:var(--gold); }
.nav-tab.locked { opacity:0.25; cursor:not-allowed; }
.nav-tab.locked:hover { color:var(--text3); }

.badge {
  background:var(--gold2); color:var(--gold);
  font-size:8px; padding:1px 5px;
  border-radius:1px; min-width:14px; text-align:center;
}

.pro-lock {
  font-size:9px; color:var(--gold2);
}

/* â”€â”€ PANELS â”€â”€ */
.panel { display:none; }
.panel.active { display:block; animation:fadeUp 0.3s ease; }

@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

/* â”€â”€ WRITE â”€â”€ */
.date-row {
  font-family:'JetBrains Mono', monospace;
  font-size:10px; color:var(--gold);
  letter-spacing:3px; text-transform:uppercase;
  margin-top: 40px;
  margin-bottom:18px;
}

textarea {
  width:100%;
  background:var(--card);
  border:1px solid var(--border2);
  color:var(--text);
  font-family:'Cormorant Garamond', serif;
  font-size:20px; font-weight:300;
  line-height:1.75; padding:26px 28px;
  resize:none; min-height:160px;
  outline:none; transition:border-color 0.3s;
  border-radius:0;
}

textarea::placeholder { color:var(--text3); font-style:italic; }
textarea:focus { border-color:var(--gold2); }

/* Photo upload area */
.photo-area {
  border:1px dashed var(--border2);
  background:var(--card);
  padding:20px;
  margin-top:10px;
  cursor:pointer;
  transition:all 0.2s;
  position:relative;
  display:none;
}

.photo-area.pro-visible { display:block; }
.photo-area:hover { border-color:var(--gold2); }

.photo-area input[type=file] {
  position:absolute; inset:0;
  opacity:0; cursor:pointer; width:100%; height:100%;
}

.photo-area-label {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:2px; text-transform:uppercase;
  text-align:center; display:flex;
  align-items:center; justify-content:center; gap:10px;
}

.photo-preview {
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top:12px;
}

.photo-thumb {
  width:64px; height:64px;
  object-fit:cover;
  border:1px solid var(--border2);
  opacity:0.8;
}

.write-footer {
  display:flex; justify-content:space-between;
  align-items:center; margin-top:10px;
}

.char-info {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3); letter-spacing:1px;
}

.btn {
  font-family:'JetBrains Mono', monospace;
  font-size:10px; letter-spacing:2px;
  text-transform:uppercase; padding:12px 26px;
  cursor:pointer; transition:all 0.2s; border-radius:0;
}

.btn-gold {
  background:var(--gold); color:var(--bg);
  border:1px solid var(--gold); font-weight:500;
}

.btn-gold:hover { background:#ccaa6a; }
.btn-gold:disabled { opacity:0.35; cursor:not-allowed; }

.btn-outline {
  background:none; border:1px solid var(--border2);
  color:var(--text3);
}

.btn-outline:hover { border-color:var(--text3); color:var(--text2); }

/* Archivista box */
.arch-box {
  margin-top:24px;
  border:1px solid var(--gold2);
  border-left:3px solid var(--gold);
  background:var(--card); padding:26px 30px;
  display:none; animation:fadeUp 0.4s ease;
  position:relative; overflow:hidden;
}

.arch-box::before {
  content:'';
  position:absolute; top:0; left:0; right:0;
  height:1px;
  background:linear-gradient(to right, var(--gold), transparent);
}

.arch-box.visible { display:block; }

.arch-label {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:3px;
  text-transform:uppercase; color:var(--gold);
  margin-bottom:14px;
  display:flex; align-items:center; gap:8px;
}

.pulse { width:5px; height:5px; border-radius:50%; background:var(--gold); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.3;transform:scale(0.8);} }

.arch-text {
  font-size:20px; line-height:1.75;
  color:var(--text); font-weight:300;
}

.arch-text em { font-style:italic; color:var(--gold); }
.arch-text strong { font-weight:600; }

.kofi-row {
  margin-top:18px; padding-top:16px;
  border-top:1px solid var(--border);
  display:none; align-items:center;
  justify-content:space-between;
}

.kofi-row.show { display:flex; }

.kofi-note {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3); letter-spacing:1px;
}

.kofi-link {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:2px;
  color:var(--gold);
  border:1px solid var(--gold2); padding:6px 14px;
  text-decoration:none; transition:all 0.2s;
}

.kofi-link:hover { border-color:var(--gold); background:var(--gold3); }

/* Loading dots */
.ldots { display:flex; gap:5px; align-items:center; height:22px; }
.ldots span { width:4px; height:4px; background:var(--gold); border-radius:50%; animation:ld 1.2s infinite; }
.ldots span:nth-child(2) { animation-delay:0.2s; }
.ldots span:nth-child(3) { animation-delay:0.4s; }
@keyframes ld { 0%,100%{opacity:0.2;transform:translateY(0);} 50%{opacity:1;transform:translateY(-4px);} }

/* entries header */
.sec-head {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:3px;
  text-transform:uppercase; color:var(--text3);
  margin:36px 0 18px;
  display:flex; align-items:center; gap:14px;
}

.sec-head::after { content:''; flex:1; height:1px; background:var(--border2); }

/* entry card */
.entry-card {
  border:1px solid var(--border);
  background:var(--card); padding:18px 22px;
  margin-bottom:8px; cursor:pointer;
  transition:all 0.2s; animation:fadeUp 0.3s ease;
}

.entry-card:hover { border-color:var(--border2); background:#131109; }
.entry-card.open { border-color:var(--gold2); }

.entry-top {
  display:flex; justify-content:space-between;
  align-items:flex-start; gap:14px;
}

.entry-date {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:2px; white-space:nowrap; flex-shrink:0;
}

.entry-prev {
  font-size:16px; color:var(--text2);
  font-weight:300; flex:1;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}

.entry-has-photo {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; color:var(--gold2); letter-spacing:1px;
}

.entry-expand {
  display:none; margin-top:14px;
  padding-top:14px; border-top:1px solid var(--border);
}

.entry-card.open .entry-expand { display:block; }

.entry-full {
  font-size:17px; color:var(--text2);
  line-height:1.7; font-weight:300; margin-bottom:12px;
}

.entry-photos { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
.entry-photo-thumb { width:80px; height:80px; object-fit:cover; border:1px solid var(--border2); opacity:0.75; }

.entry-arch {
  font-size:15px; font-style:italic;
  color:var(--text3); padding-left:12px;
  border-left:2px solid var(--gold2);
  line-height:1.65;
}

/* â”€â”€ UPGRADE SCREEN â”€â”€ */
#upgrade-screen {
  position:fixed; inset:0;
  background:#050504;
  z-index:8000;
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  padding:40px;
  animation:fadeUp 0.4s ease;
}

#upgrade-screen.visible { display:flex; }

.upgrade-inner { max-width:560px; width:100%; }

.upgrade-eyebrow {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:4px;
  color:var(--text3); text-transform:uppercase;
  margin-bottom:28px;
}

.upgrade-title {
  font-family:'Cormorant Garamond', serif;
  font-size:42px; font-weight:300;
  color:var(--text); line-height:1.15;
  margin-bottom:8px;
}

.upgrade-title em { font-style:italic; color:var(--gold); }

.upgrade-sub {
  font-family:'JetBrains Mono', monospace;
  font-size:10px; color:var(--text3);
  letter-spacing:1px; margin-bottom:48px;
}

.upgrade-divider {
  height:1px;
  background:linear-gradient(to right, var(--gold2), transparent);
  margin-bottom:40px;
}

.upgrade-features { margin-bottom:44px; }

.uf-row {
  display:grid; grid-template-columns:1fr 1fr;
  gap:0; margin-bottom:1px;
}

.uf-cell {
  padding:16px 20px;
  background:var(--card);
  border:1px solid var(--border);
  margin:-1px 0 0 -1px;
}

.uf-cell:first-child {
  border-right-color:var(--border2);
}

.uf-plan {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; letter-spacing:3px;
  text-transform:uppercase; margin-bottom:10px;
}

.uf-plan.free { color:var(--text3); }
.uf-plan.pro { color:var(--gold); }

.uf-price {
  font-family:'Cormorant Garamond', serif;
  font-size:30px; font-weight:300;
  line-height:1; margin-bottom:4px;
}

.uf-price.free { color:var(--text2); }
.uf-price.pro { color:var(--gold); }

.uf-period {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; color:var(--text3);
  letter-spacing:1px; margin-bottom:16px;
}

.uf-feature {
  font-size:14px; color:var(--text2);
  font-weight:300; line-height:1.7;
  padding:3px 0;
  display:flex; align-items:flex-start; gap:8px;
}

.uf-feature::before { content:'â€”'; color:var(--text3); flex-shrink:0; }
.uf-feature.pro-only { color:var(--text); }
.uf-feature.pro-only::before { content:'âœ¦'; color:var(--gold); font-size:10px; }

.upgrade-cta {
  display:flex; flex-direction:column;
  align-items:flex-start; gap:12px;
}

.upgrade-note {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:1px; line-height:1.7;
}

.upgrade-close {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:2px;
  color:var(--text3); background:none;
  border:none; cursor:pointer;
  text-transform:uppercase; margin-top:4px;
  transition:color 0.2s;
}

.upgrade-close:hover { color:var(--text2); }

/* â”€â”€ INSIGHT OVERLAY â”€â”€ */
#insight-overlay {
  position:fixed; inset:0;
  background:#040403;
  z-index:9500;
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  padding:48px;
  opacity:0; transition:opacity 1.2s ease;
}

#insight-overlay.visible { display:flex; }
#insight-overlay.faded { opacity:1; }

.io-eyebrow {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:5px;
  color:var(--text3); text-transform:uppercase;
  margin-bottom:64px;
  opacity:0; transform:translateY(6px);
  transition:all 0.8s ease 0.6s;
}

.io-eyebrow.s { opacity:1; transform:translateY(0); }

.io-dates {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:3px;
  color:var(--gold2); text-transform:uppercase;
  margin-bottom:28px;
  opacity:0; transition:all 0.8s ease 1.2s;
}

.io-dates.s { opacity:1; }

.io-text {
  font-family:'Cormorant Garamond', serif;
  font-size:clamp(20px, 3vw, 32px);
  font-weight:300; line-height:1.7;
  color:var(--text); text-align:center;
  max-width:640px;
  opacity:0; transform:translateY(14px);
  transition:all 1.2s ease 1.6s;
}

.io-text.s { opacity:1; transform:translateY(0); }
.io-text em { font-style:italic; color:var(--gold); }

.io-line {
  width:1px; height:0;
  background:linear-gradient(to bottom, var(--gold2), transparent);
  margin:44px auto;
  transition:height 0.9s ease 3s;
}

.io-line.s { height:56px; }

.io-actions {
  display:flex; flex-direction:column;
  align-items:center; gap:14px;
  opacity:0; transition:all 0.8s ease 3.6s;
}

.io-actions.s { opacity:1; }

.io-kofi {
  font-family:'JetBrains Mono', monospace;
  font-size:10px; letter-spacing:2px;
  color:var(--gold);
  border:1px solid var(--gold2); padding:13px 32px;
  text-decoration:none; transition:all 0.2s;
}

.io-kofi:hover { border-color:var(--gold); background:var(--gold3); }

.io-dismiss {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:2px;
  color:var(--text3); background:none;
  border:none; cursor:pointer;
  text-transform:uppercase; transition:color 0.2s;
}

.io-dismiss:hover { color:var(--text2); }

/* â”€â”€ WORLD ALERT â”€â”€ */
#world-alert {
  position: fixed;
  inset: 0;
  background: rgba(4, 3, 2, 0.98);
  z-index: 9700;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px;
  opacity: 0;
  transition: opacity 1s ease;
}

#world-alert.visible { display: flex; }
#world-alert.faded { opacity: 1; }

.wa-eyebrow {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px; letter-spacing: 5px;
  color: #8b3a2a; text-transform: uppercase;
  margin-bottom: 40px;
  opacity: 0; transition: opacity 0.8s ease 0.5s;
}

.wa-eyebrow.s { opacity: 1; }

.wa-country {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: 3px;
  color: var(--text3); text-transform: uppercase;
  margin-bottom: 20px;
  opacity: 0; transition: opacity 0.8s ease 0.8s;
}

.wa-country.s { opacity: 1; }

.wa-headline {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(20px, 3vw, 30px);
  font-weight: 300; line-height: 1.6;
  color: var(--text); text-align: center;
  max-width: 620px; font-style: italic;
  opacity: 0; transform: translateY(12px);
  transition: all 1s ease 1.2s;
}

.wa-headline.s { opacity: 1; transform: translateY(0); }

.wa-carlitos {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; letter-spacing: 1px;
  color: var(--text3); margin-top: 32px;
  max-width: 500px; text-align: center;
  line-height: 1.8;
  opacity: 0; transition: opacity 0.8s ease 2.2s;
}

.wa-carlitos.s { opacity: 1; }

.wa-privacy {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px; letter-spacing: 1px;
  color: var(--text3); margin-top: 48px;
  opacity: 0; transition: opacity 0.8s ease 2.8s;
  border-top: 1px solid var(--border);
  padding-top: 14px; text-align: center;
}

.wa-privacy.s { opacity: 0.5; }

.wa-close {
  margin-top: 20px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: 2px;
  color: var(--text3); background: none;
  border: none; cursor: pointer;
  text-transform: uppercase; transition: color 0.2s;
  opacity: 0; transition: opacity 0.8s ease 3.2s;
}

.wa-close.s { opacity: 1; }
.wa-close:hover { color: var(--text2); }

/* â”€â”€ THOUGHT OVERLAY â”€â”€ */
#thought-overlay {
  position: fixed;
  inset: 0;
  background: rgba(4, 4, 3, 0.97);
  z-index: 9600;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px;
  opacity: 0;
  transition: opacity 1.4s ease;
  cursor: pointer;
}

#thought-overlay.visible { display: flex; }
#thought-overlay.faded { opacity: 1; }

.thought-eyebrow {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px;
  letter-spacing: 5px;
  color: var(--text3);
  text-transform: uppercase;
  margin-bottom: 52px;
  opacity: 0;
  transition: opacity 1s ease 0.5s;
}

.thought-eyebrow.s { opacity: 1; }

.thought-words {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(22px, 3.5vw, 36px);
  font-weight: 300;
  font-style: italic;
  line-height: 1.7;
  color: var(--text2);
  text-align: center;
  max-width: 600px;
}

.thought-word {
  display: inline;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.thought-word.show { opacity: 1; }

.thought-dismiss {
  position: absolute;
  bottom: 36px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px;
  letter-spacing: 2px;
  color: var(--text3);
  opacity: 0;
  transition: opacity 0.5s ease 2s;
}

#thought-overlay.faded .thought-dismiss { opacity: 1; }

/* â”€â”€ PROMISES â”€â”€ */
.promise-item {
  border:1px solid var(--border2);
  background:var(--card); padding:18px 22px;
  margin-bottom:8px;
  display:flex; gap:18px; align-items:flex-start;
  position:relative; animation:fadeUp 0.3s ease;
}

.promise-item::before {
  content:''; position:absolute;
  left:0; top:0; bottom:0;
  width:2px; background:var(--green);
}

.promise-age {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:1px; white-space:nowrap; min-width:70px;
}

.promise-age.old { color:#c06050; }

.promise-body { flex:1; }

.promise-text {
  font-size:17px; color:var(--text2);
  font-weight:300; line-height:1.6;
  font-style:italic;
}

.promise-from {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; color:var(--text3);
  letter-spacing:1px; margin-top:6px;
}

.promise-btns { display:flex; gap:8px; margin-top:10px; }

.pbtn {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; letter-spacing:1px;
  padding:4px 10px; cursor:pointer;
  border:1px solid; background:none;
  transition:all 0.2s;
}

.pbtn.done { border-color:var(--green); color:var(--green); }
.pbtn.done:hover { background:var(--green); color:var(--bg); }
.pbtn.skip { border-color:var(--red); color:#c06050; }
.pbtn.skip:hover { background:var(--red); color:var(--text); }

/* â”€â”€ CONTRADICTIONS â”€â”€ */
.c-intro {
  font-size:16px; color:var(--text2);
  font-weight:300; font-style:italic;
  line-height:1.7; margin-bottom:24px;
  padding:18px 22px;
  border-left:2px solid var(--red);
  background:#110a0a;
}

.c-item {
  border:1px solid var(--border2);
  background:var(--card); padding:22px;
  margin-bottom:10px;
  position:relative; animation:fadeUp 0.3s ease;
}

.c-item::before {
  content:''; position:absolute;
  left:0; top:0; bottom:0;
  width:2px; background:var(--red);
}

.c-dates {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:2px; margin-bottom:14px;
  display:flex; gap:16px;
}

.c-pair {
  display:grid; grid-template-columns:1fr auto 1fr;
  gap:14px; align-items:start;
}

.c-side { font-size:16px; color:var(--text2); font-weight:300; line-height:1.6; }
.c-side em { font-style:italic; color:var(--text); }
.c-arr { color:var(--red); font-size:18px; }
.c-note { margin-top:12px; font-family:'JetBrains Mono', monospace; font-size:9px; color:var(--text3); letter-spacing:1px; }

/* â”€â”€ VERSIONS â”€â”€ */
.v-item {
  border:1px solid var(--border2);
  background:var(--card); padding:26px;
  margin-bottom:12px;
  position:relative; animation:fadeUp 0.3s ease;
}

.v-item::before {
  content:''; position:absolute;
  left:0; top:0; bottom:0;
  width:2px; background:var(--blue);
}

.v-period {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:3px; text-transform:uppercase;
  margin-bottom:10px;
}

.v-name {
  font-family:'Cormorant Garamond', serif;
  font-size:26px; font-weight:300;
  font-style:italic; color:var(--text);
  margin-bottom:10px;
}

.v-desc { font-size:16px; color:var(--text2); font-weight:300; line-height:1.7; }

.v-themes { display:flex; gap:6px; flex-wrap:wrap; margin-top:12px; }

.v-tag {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; padding:3px 9px;
  border:1px solid var(--blue); color:#5a8ab0;
  letter-spacing:1px;
}

/* â”€â”€ INTERROGATORIO â”€â”€ */
.interro-wrap {
  border:1px solid var(--gold2);
  background:var(--card); padding:36px;
  position:relative; overflow:hidden;
}

.interro-wrap::before {
  content:'';
  position:absolute; top:0; left:0; right:0;
  height:2px;
  background:linear-gradient(to right, var(--gold), var(--gold2), transparent);
}

.interro-head {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:3px;
  color:var(--gold); text-transform:uppercase;
  margin-bottom:28px;
  display:flex; align-items:center; gap:8px;
}

.q-block { margin-bottom:26px; padding-bottom:26px; border-bottom:1px solid var(--border); }
.q-block:last-of-type { border-bottom:none; }

.q-num {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:2px; margin-bottom:8px;
}

.q-text { font-size:21px; font-weight:300; color:var(--text); line-height:1.6; margin-bottom:14px; }

.q-ans {
  width:100%;
  background:#090807;
  border:1px solid var(--border2);
  color:var(--text);
  font-family:'Cormorant Garamond', serif;
  font-size:18px; font-weight:300;
  padding:14px 18px; resize:none;
  min-height:72px; outline:none;
  transition:border-color 0.2s;
}

.q-ans:focus { border-color:var(--gold2); }

.interro-footer {
  margin-top:22px;
  display:flex; justify-content:space-between; align-items:center;
}

.interro-note {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3); letter-spacing:1px;
}

/* â”€â”€ LOCKED STATE â”€â”€ */
.locked-panel {
  text-align:center; padding:70px 30px;
  border:1px dashed var(--border2);
}

.locked-icon { font-size:28px; color:var(--text3); margin-bottom:18px; }

.locked-title {
  font-family:'Cormorant Garamond', serif;
  font-size:22px; font-weight:300;
  font-style:italic; color:var(--text2);
  margin-bottom:8px;
}

.locked-desc {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--text3);
  letter-spacing:1px; line-height:1.9;
}

.locked-bar-wrap {
  max-width:180px; margin:20px auto 0;
  background:var(--border); height:2px; border-radius:1px; overflow:hidden;
}

.locked-bar { height:100%; background:var(--gold2); transition:width 0.5s ease; }

/* â”€â”€ EMPTY â”€â”€ */
.empty {
  text-align:center; padding:50px 20px;
  border:1px dashed var(--border2);
  color:var(--text3); font-size:16px; font-style:italic;
}

/* â”€â”€ PROMISE MODAL â”€â”€ */
#promise-modal {
  position:fixed; inset:0;
  background:#000000cc; z-index:8500;
  display:none; align-items:center; justify-content:center;
}

.promise-modal-inner {
  background:var(--card);
  border:1px solid var(--gold2);
  border-top:2px solid var(--gold);
  max-width:500px; width:90%; padding:34px;
}

.pm-head {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:3px;
  color:var(--gold); text-transform:uppercase;
  margin-bottom:18px;
}

.pm-list { margin-bottom:22px; }

.pm-item {
  padding:12px 0; border-bottom:1px solid var(--border);
  font-size:17px; color:var(--text2);
  font-style:italic; font-weight:300;
}

.pm-item:last-child { border-bottom:none; }

.pm-footer { display:flex; gap:10px; justify-content:flex-end; }

/* â”€â”€ FOOTER â”€â”€ */
.site-footer {
  position:fixed; bottom:0; left:0; right:0;
  background:var(--bg);
  border-top:1px solid var(--border);
  padding:9px 28px;
  display:flex; align-items:center; justify-content:space-between;
  z-index:100;
}

.footer-note {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; color:var(--text3); letter-spacing:1px;
}

.footer-btns { display:flex; gap:16px; align-items:center; }

.footer-btn {
  font-family:'JetBrains Mono', monospace;
  font-size:8px; letter-spacing:1px;
  background:none; border:none; cursor:pointer;
  padding:3px 0; transition:color 0.2s;
}

.footer-btn.upgrade { color:var(--gold); border-bottom:1px solid var(--gold2); }
.footer-btn.upgrade:hover { border-bottom-color:var(--gold); }
.footer-btn.danger { color:var(--text3); }
.footer-btn.danger:hover { color:#c06050; }

/* â”€â”€ HOOK & RETURN â”€â”€ */
.carlitos-hook {
  margin-top: 18px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--gold2);
  letter-spacing: 2px;
}

#return-greeting {
  border: 1px solid var(--border2);
  border-left: 3px solid var(--gold2);
  background: var(--card);
  padding: 18px 22px;
  margin-bottom: 20px;
  font-size: 18px;
  color: var(--text2);
  font-weight: 300;
  font-style: italic;
  line-height: 1.65;
  display: none;
  animation: fadeUp 0.4s ease;
}

#return-greeting em { color: var(--gold); font-style: italic; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:48px; right:28px;
  background:var(--card);
  border:1px solid var(--gold2);
  border-left:3px solid var(--gold);
  padding:12px 18px;
  font-family:'JetBrains Mono', monospace;
  font-size:9px; color:var(--gold); letter-spacing:1px;
  animation:fadeUp 0.3s ease; z-index:9998;
  max-width:280px;
}

@keyframes toastOut { to { opacity:0; transform:translateY(8px); } }

/* Demo button */
.demo-btn {
  text-align:center; margin-top:24px;
}

.demo-btn button {
  font-family:'JetBrains Mono', monospace;
  font-size:9px; letter-spacing:2px;
  color:var(--text3); background:none;
  border:1px dashed var(--border2);
  padding:7px 18px; cursor:pointer;
  transition:all 0.2s;
}

.demo-btn button:hover { color:var(--gold); border-color:var(--gold2); }
</style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo-row">
      <div class="logo">Contale a <em>Carlitos</em></div>
      <span class="pro-badge" id="pro-badge">Pro</span>
    </div>
    <div class="tagline">Carlitos recuerda todo. <em>Todo.</em></div>
  </header>

  <!-- WRITE -->
  <div class="panel active" id="panel-write">
    <div class="date-row" id="date-label">â€”</div>
    <div id="return-greeting"></div>

    <textarea id="entry-input" placeholder="Contale a Carlitos. Ã‰l recuerda todo." maxlength="3000"></textarea>

    <!-- Photo upload (Pro only) -->
    <div class="photo-area" id="photo-area">
      <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotos(this)">
      <div class="photo-area-label">
        <span>âœ¦</span>
        <span>Adjuntar fotos â€” Carlitos las cruza con tus entradas</span>
      </div>
      <div class="photo-preview" id="photo-preview"></div>
    </div>

    <div class="write-footer">
      <span class="char-info"><span id="char-count">0</span> / 3000</span>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn btn-outline" id="photo-trigger-btn" onclick="triggerPhotoUpgrade()" style="font-size:16px;padding:8px 14px;background:var(--card);border:1px solid var(--border2);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#b8965a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button class="btn btn-gold" id="save-btn" onclick="saveEntry()">AnotÃ¡, Carlitos</button>
      </div>
    </div>

    <div class="arch-box" id="arch-box">
      <div class="arch-label"><span class="pulse"></span>Carlitos</div>
      <div class="arch-text" id="arch-text"><div class="ldots"><span></span><span></span><span></span></div></div>
      <div class="kofi-row" id="kofi-row">
        <span class="kofi-note">Si Carlitos te volÃ³ la cabeza</span>
        <a href="https://ko-fi.com/nineplus" target="_blank" class="kofi-link">â˜• $5 â†’</a>
      </div>
    </div>

    <div class="sec-head">Entradas recientes</div>
    <div id="recent-entries"></div>

    <div id="all-entries-wrap" style="display:none">
      <div class="sec-head" style="margin-top:28px">Todas las entradas</div>
      <div id="all-entries"></div>
    </div>

    <div style="text-align:center;margin-top:20px;" id="ver-todo-wrap">
      <button onclick="toggleAllEntries()" id="ver-todo-btn" style="font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);background:none;border:none;cursor:pointer;transition:color 0.2s;" onmouseover="this.style.color='var(--gold)'" onmouseout="this.style.color='var(--text3)'">Ver todo â†’</button>
    </div>

    <div class="demo-btn">
      <button onclick="generateInsight(true)" style="margin-right:12px">Ver demo del insight â†’</button>
      <button onclick="showThought(true)">Ver Carlitos pensando â†’</button>
    </div>
  </div>

</div>

<!-- UPGRADE SCREEN -->
<div id="upgrade-screen">
  <div class="upgrade-inner">
    <div class="upgrade-eyebrow">Carlitos Pro</div>
    <div class="upgrade-title">El archivo <em>completo</em></div>
    <div class="upgrade-sub">Texto, fotos, patrones. Todo en el mismo lugar.</div>
    <div class="upgrade-divider"></div>

    <div class="upgrade-features">
      <div class="uf-row">
        <div class="uf-cell">
          <div class="uf-plan free">Gratuito</div>
          <div class="uf-price free">$0</div>
          <div class="uf-period">siempre</div>
          <div class="uf-feature">Entradas de texto ilimitadas</div>
          <div class="uf-feature">Carlitos recuerda y cruza todo</div>
          <div class="uf-feature">Memoria de personas</div>
          <div class="uf-feature">Insight especial cada 3 dÃ­as</div>
        </div>
        <div class="uf-cell">
          <div class="uf-plan pro">Pro</div>
          <div class="uf-price pro">$5</div>
          <div class="uf-period">por mes Â· vÃ­a Ko-fi</div>
          <div class="uf-feature">Todo lo anterior</div>
          <div class="uf-feature pro-only">Fotos adjuntas a entradas</div>
          <div class="uf-feature pro-only">Carlitos cruza fotos con texto</div>
          <div class="uf-feature pro-only">AnÃ¡lisis de patrones visuales</div>
          <div class="uf-feature pro-only">SÃ­ntesis visual enriquecida</div>
        </div>
      </div>
    </div>

    <div class="upgrade-cta">
      <a href="https://ko-fi.com/nineplus/tiers" target="_blank" class="btn btn-gold" style="text-decoration:none;font-size:10px;">Suscribirse por $5/mes â†’</a>
      <div class="upgrade-note">
        Pago vÃ­a Ko-fi Â· Tarjeta de crÃ©dito o dÃ©bito desde cualquier paÃ­s<br>
        DespuÃ©s de suscribirte, activÃ¡ Pro con el cÃ³digo que recibÃ­s por email.
      </div>
      <button class="upgrade-close" onclick="closeUpgrade()">Quedarme en la versiÃ³n gratuita</button>
    </div>
  </div>
</div>

<!-- WORLD ALERT -->
<div id="world-alert">
  <div class="wa-eyebrow" id="wa-ey">Afuera estÃ¡ pasando algo</div>
  <div class="wa-country" id="wa-country"></div>
  <div class="wa-headline" id="wa-headline"></div>
  <div class="wa-carlitos" id="wa-carlitos"></div>
  <div class="wa-privacy" id="wa-privacy">Carlitos detectÃ³ tu paÃ­s por IP para mostrarte esto. Nada mÃ¡s.</div>
  <button class="wa-close" id="wa-close" onclick="dismissWorldAlert()">Igual, contame â†’</button>
</div>

<!-- THOUGHT OVERLAY -->
<div id="thought-overlay" onclick="dismissThought()">
  <div class="thought-words" id="th-words"></div>
  <div class="thought-dismiss">toca para cerrar</div>
</div>

<!-- INSIGHT OVERLAY -->
<div id="insight-overlay">
  <div class="io-eyebrow" id="io-ey">Carlitos tiene algo que decirte</div>
  <div class="io-dates" id="io-dates"></div>
  <div class="io-text" id="io-text"></div>
  <div class="io-line" id="io-line"></div>
  <div class="io-actions" id="io-actions">
    <button class="io-dismiss" onclick="dismissInsight()">Cerrar y continuar</button>
  </div>
</div>

<!-- PROMISE MODAL -->
<div id="promise-modal">
  <div class="promise-modal-inner">
    <div class="pm-head">Compromisos detectados</div>
    <div class="pm-list" id="pm-list"></div>
    <div class="pm-footer">
      <button class="btn btn-outline" onclick="dismissPromises()">No archivar</button>
      <button class="btn btn-gold" onclick="confirmPromises()">Archivar</button>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <span class="footer-note">Lo que escribÃ­s lo lee Carlitos, no su creador Â· Datos guardados localmente en tu navegador</span>
  <div class="footer-btns">
    <button class="footer-btn" id="install-btn" onclick="installApp()" style="display:none">âŠž Instalar app</button>
    <button class="footer-btn upgrade" onclick="showUpgrade()">âœ¦ Activar Pro</button>
    <button class="footer-btn danger" onclick="confirmDeleteAll()">Borrar archivo</button>
  </div>
</footer>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK = 'carlitos_v1';
let state = JSON.parse(localStorage.getItem(SK) || 'null') || {
  entries: [], promises: [], pendingPromises: [],
  contradictions: [], versions: [],
  people: {},
  lastInterrogatorio: null, lastInsight: null,
  interrogatorioAnswers: [], firstUsed: Date.now(),
  isPro: false
};

if (!state.pendingPromises) state.pendingPromises = [];

function save() { localStorage.setItem(SK, JSON.stringify(state)); }

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const today = new Date();
const dateStr = today.toLocaleDateString('es-AR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
const dateShort = today.toLocaleDateString('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' });
document.getElementById('date-label').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

const input = document.getElementById('entry-input');
input.addEventListener('input', () => document.getElementById('char-count').textContent = input.value.length);
input.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') saveEntry(); });

// â”€â”€ PRO STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyProState() {
  if (state.isPro) {
    document.getElementById('pro-badge').classList.add('visible');
    document.getElementById('photo-area').classList.add('pro-visible');
    document.getElementById('photo-trigger-btn').style.display = 'none';
  }
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
  const activeTab = document.querySelector(`.nav-tab[onclick="switchTab('${name}')"]`);
  if (activeTab) activeTab.classList.add('active');
  const panel = document.getElementById('panel-' + name);
  if (panel) panel.classList.add('active');
}

function toggleAllEntries() {
  const wrap = document.getElementById('all-entries-wrap');
  const btn = document.getElementById('ver-todo-btn');
  const isVisible = wrap.style.display !== 'none';
  if (isVisible) {
    wrap.style.display = 'none';
    btn.textContent = 'Ver todo â†’';
  } else {
    renderAllEntries();
    wrap.style.display = 'block';
    btn.textContent = 'Ocultar â†’';
  }
}

function unlockTabs() {
  const verTodo = document.getElementById('ver-todo-wrap');
  if (verTodo) verTodo.style.display = state.entries.length > 5 ? 'block' : 'none';
}

// â”€â”€ PHOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingPhotos = [];
let pendingPhotoData = [];

function triggerPhotoUpgrade() {
  showUpgrade();
}

function handlePhotos(input) {
  const files = Array.from(input.files);
  const preview = document.getElementById('photo-preview');
  preview.innerHTML = '';
  pendingPhotos = [];
  pendingPhotoData = [];

  files.slice(0, 4).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.className = 'photo-thumb';
      preview.appendChild(img);
      pendingPhotos.push(e.target.result);

      // Store base64 for API
      const base64 = e.target.result.split(',')[1];
      const mediaType = file.type;
      pendingPhotoData.push({ base64, mediaType });
    };
    reader.readAsDataURL(file);
  });
}

// â”€â”€ SAVE ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveEntry() {
  const text = input.value.trim();
  if (!text) return;

  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.textContent = 'Archivando...';

  const archBox = document.getElementById('arch-box');
  const archText = document.getElementById('arch-text');
  archBox.classList.add('visible');
  archText.innerHTML = '<div class="ldots"><span></span><span></span><span></span></div>';
  document.getElementById('kofi-row').classList.remove('show');

  const historyCtx = state.entries.slice(-20).map(e => `[${e.dateShort}]: "${e.text}"`).join('\n') || 'Sin historial previo.';
  const n = state.entries.length;

  const escalation = n <= 2
    ? 'PROFUNDIDAD: Baja. Pocas entradas. ObservÃ¡ sin presionar. Pregunta final suave.'
    : n <= 6
    ? 'PROFUNDIDAD: Media. Patrones emergiendo. Si algo se repite, seÃ±alalo con mÃ¡s peso.'
    : 'PROFUNDIDAD: Alta. Historial suficiente. La pregunta final aprieta exactamente donde corresponde.';

  const hasPhotos = pendingPhotoData.length > 0;

  // Build people context for prompt
  const peopleCtx = Object.keys(state.people || {}).length > 0
    ? 'PERSONAS QUE CARLITOS RECUERDA:\n' + Object.entries(state.people).map(([name, data]) =>
        `- ${name}: mencionado ${data.count} veces. Contextos: ${(data.contexts || []).slice(-3).join(' / ')}`
      ).join('\n')
    : '';

  const prompt = `Sos Carlitos. Sos el amigo que recuerda todo y dice lo que nadie mÃ¡s se anima a decir. No humillÃ¡s, no daÃ±Ã¡s, no juzgÃ¡s â€” pero tampoco anestesiÃ¡s. DecÃ­s lo que ves, directo, sin vueltas, como alguien que te quiere pero no te va a mentir.

TONO: Directo como un amigo, no como un terapeuta. Nada de "podrÃ­a ser que", "quizÃ¡s", "es interesante". Tampoco sos cruel ni sarcÃ¡stico. Sos el que dice "parÃ¡, Â¿te acordÃ¡s que el mes pasado dijiste exactamente lo contrario?" â€” sin drama, solo los hechos.

${escalation}

LO QUE SABÃ‰S (no lo mencionÃ¡s nunca):
- El vocabulario que alguien repite lo estÃ¡ construyendo. Lo rastreÃ¡s en silencio.
- Los patrones pequeÃ±os dicen mÃ¡s que los grandes. Los ponÃ©s juntos sin nombrarlos.

${peopleCtx}

HISTORIAL (${n} entradas):
${historyCtx}

NUEVA ENTRADA [${dateShort}]:
"${text}"

DevolvÃ© SOLO este JSON, sin texto extra, sin backticks:
{
  "internal_themes": ["3-5 temas internos, nunca visibles"],
  "archivista": "2-3 oraciones como un amigo directo. Si hay historial: citÃ¡ fecha y hecho concreto sin explicar por quÃ© lo citÃ¡s. CerrÃ¡ con UNA pregunta que el usuario no querrÃ­a responder pero necesita. MÃ¡x 65 palabras. Sin crueldad, sin anestesia.${hasPhotos ? ' Si hay fotos: integralas como parte natural de lo que observÃ¡s.' : ''}",
  "promises": ["promesas reales detectadas. MÃ¡x 3. Array vacÃ­o si no hay."],
  "contradiction": {
    "found": true o false,
    "entry1_date": "fecha exacta",
    "entry1_text": "fragmento mÃ­nimo",
    "entry2_text": "fragmento mÃ­nimo de hoy",
    "note": "una oraciÃ³n que pone las dos cosas juntas, sin juicio"
  },
  "people": [
    {
      "name": "nombre o rol como 'Lucas' o 'mi jefa' â€” inferÃ­ y agrupÃ¡ si creÃ©s que son la misma persona",
      "sentiment": "positivo / negativo / ambivalente / neutro",
      "context": "una frase corta sobre cÃ³mo apareciÃ³ en esta entrada"
    }
  ],
  "hook": "Una lÃ­nea suelta, como hablando solo. Algo que deja al usuario pensando hasta maÃ±ana. Ejemplo: 'MaÃ±ana fijate si esto sigue siendo verdad.' o 'Acordate de esto.' Que sea especÃ­fico a lo que escribiÃ³, no genÃ©rico. MÃ¡x 8 palabras."
}`;

  try {
    // Build message content
    const msgContent = [];

    // Add photos if present
    if (hasPhotos && state.isPro) {
      pendingPhotoData.forEach(p => {
        msgContent.push({ type: 'image', source: { type: 'base64', media_type: p.mediaType, data: p.base64 } });
      });
    }

    msgContent.push({ type: 'text', text: prompt });

    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{ role: "user", content: msgContent }]
      })
    });

    const data = await res.json();
    const raw = data.content.map(i => i.text || "").join("");

    let parsed;
    try { parsed = JSON.parse(raw.replace(/```json|```/g, "").trim()); }
    catch { parsed = { internal_themes: [], archivista: raw.slice(0, 400), promises: [], contradiction: { found: false } }; }

    const entry = {
      id: Date.now(), date: dateStr, dateShort, text,
      internal_themes: parsed.internal_themes || [],
      archivista: parsed.archivista || "",
      hook: parsed.hook || "",
      photos: pendingPhotos.slice()
    };

    state.entries.push(entry);

    // Pending promises
    const detected = (parsed.promises || []).filter(p => p && p.length > 3);
    if (detected.length > 0) {
      state.pendingPromises = detected.map(p => ({
        id: Date.now() + Math.random(), text: p,
        date: dateShort, entryId: entry.id,
        status: 'open', createdAt: today.getTime()
      }));
    }

    // Contradiction
    if (parsed.contradiction && parsed.contradiction.found) {
      state.contradictions.push({
        id: Date.now() + 1,
        date1: parsed.contradiction.entry1_date,
        text1: parsed.contradiction.entry1_text,
        date2: dateShort,
        text2: parsed.contradiction.entry2_text,
        note: parsed.contradiction.note
      });
      setTimeout(() => showToast("ContradicciÃ³n registrada"), 1500);
    }

    // People memory â€” accumulate silently
    if (!state.people) state.people = {};
    (parsed.people || []).forEach(p => {
      if (!p.name || p.name.length < 2) return;
      const key = p.name.toLowerCase().trim();
      if (!state.people[key]) {
        state.people[key] = { name: p.name, count: 0, contexts: [], sentiments: [] };
      }
      state.people[key].count++;
      state.people[key].contexts.push(`[${dateShort}] ${p.context || ''}`);
      state.people[key].sentiments.push(p.sentiment || 'neutro');
      // Keep only last 10 contexts
      if (state.people[key].contexts.length > 10) state.people[key].contexts = state.people[key].contexts.slice(-10);
    });

    if (state.entries.length % 5 === 0 && state.entries.length >= 5) analyzeVersions();

    // Maybe show a thought
    if (shouldShowThought()) {
      setTimeout(() => showThought(), 2000);
    }

    save();
    unlockTabs();
    renderRecentEntries();

    archText.innerHTML = formatText(parsed.archivista || "") + (parsed.hook ? `<div class="carlitos-hook">${parsed.hook}</div>` : '');

    // Save last entry timestamp for return detection
    state.lastEntryTime = Date.now();

    if (state.entries.length > 1) {
      document.getElementById('kofi-row').classList.add('show');
    }

    input.value = "";
    document.getElementById('char-count').textContent = "0";
    document.getElementById('photo-preview').innerHTML = "";
    pendingPhotos = [];
    pendingPhotoData = [];

    if (detected.length > 0) showPromiseModal(detected);

  } catch(err) {
    archText.innerHTML = `<em>Error al conectar. IntentÃ¡ de nuevo.</em>`;
  }

  btn.disabled = false;
  btn.textContent = 'Archivar â†’ Ctrl+Enter';
}

function formatText(t) {
  return t
    .replace(/["Â«Â»""]/g, m => `<em>${m}</em>`)
    .replace(/\b(\d{1,2}\/\d{1,2}\/\d{2,4})\b/g, '<strong>$1</strong>');
}

// â”€â”€ RENDER ENTRIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function entryHTML(e) {
  const photos = (e.photos || []).slice(0, 4);
  return `
    <div class="entry-card" onclick="this.classList.toggle('open')">
      <div class="entry-top">
        <span class="entry-date">${e.dateShort}</span>
        <span class="entry-prev">${e.text.slice(0, 85)}${e.text.length > 85 ? '...' : ''}</span>
        ${photos.length > 0 ? `<span class="entry-has-photo">ðŸ“· ${photos.length}</span>` : ''}
      </div>
      <div class="entry-expand">
        <div class="entry-full">${e.text}</div>
        ${photos.length > 0 ? `<div class="entry-photos">${photos.map(p => `<img src="${p}" class="entry-photo-thumb">`).join('')}</div>` : ''}
        ${e.archivista ? `<div class="entry-arch">${e.archivista}</div>` : ''}
      </div>
    </div>`;
}

function renderRecentEntries() {
  const c = document.getElementById('recent-entries');
  const r = [...state.entries].reverse().slice(0, 5);
  c.innerHTML = r.length ? r.map(entryHTML).join('') : '<div class="empty">TodavÃ­a no hay entradas.</div>';
}

function renderAllEntries() {
  const c = document.getElementById('all-entries');
  const all = [...state.entries].reverse();
  c.innerHTML = all.length ? all.map(entryHTML).join('') : '<div class="empty">Sin entradas.</div>';
}

// â”€â”€ PROMISES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPromiseModal(promises) {
  const list = document.getElementById('pm-list');
  list.innerHTML = promises.map(p => `<div class="pm-item">"${p}"</div>`).join('');
  document.getElementById('promise-modal').style.display = 'flex';
}

function confirmPromises() {
  (state.pendingPromises || []).forEach(p => state.promises.push(p));
  state.pendingPromises = [];
  save(); unlockTabs();
  document.getElementById('promise-modal').style.display = 'none';
  showToast(`Compromisos archivados`);
}

function dismissPromises() {
  state.pendingPromises = [];
  save();
  document.getElementById('promise-modal').style.display = 'none';
}

function renderPromises() {
  const c = document.getElementById('promises-content');
  const open = state.promises.filter(p => p.status === 'open');
  const closed = state.promises.filter(p => p.status !== 'open');

  if (state.entries.length < 2 && open.length === 0) {
    c.innerHTML = lockedHTML("Promesas", "El archivo necesita mÃ¡s entradas para detectar compromisos.", state.entries.length, 2);
    return;
  }

  let html = '';
  if (open.length > 0) {
    html += `<div class="sec-head">Sin resolver (${open.length})</div>`;
    html += open.map(p => {
      const days = Math.floor((Date.now() - p.createdAt) / 86400000);
      return `<div class="promise-item">
        <div class="promise-age ${days > 14 ? 'old' : ''}">${days === 0 ? 'hoy' : `hace ${days}d`}</div>
        <div class="promise-body">
          <div class="promise-text">"${p.text}"</div>
          <div class="promise-from">Detectado el ${p.date}</div>
          <div class="promise-btns">
            <button class="pbtn done" onclick="resolvePromise('${p.id}','done')">Lo hice</button>
            <button class="pbtn skip" onclick="resolvePromise('${p.id}','ignored')">Lo ignorÃ©</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }
  if (closed.length > 0) {
    html += `<div class="sec-head" style="margin-top:28px">Cerradas (${closed.length})</div>`;
    html += closed.map(p => `<div class="promise-item" style="opacity:0.4">
      <div class="promise-age">${p.status}</div>
      <div class="promise-body"><div class="promise-text">"${p.text}"</div></div>
    </div>`).join('');
  }
  if (!html) html = '<div class="empty">No se detectaron promesas todavÃ­a.</div>';
  c.innerHTML = html;
}

function resolvePromise(id, status) {
  const p = state.promises.find(p => String(p.id) === String(id));
  if (p) { p.status = status; save(); renderPromises(); unlockTabs(); }
}

// â”€â”€ CONTRADICTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContradictions() {
  const c = document.getElementById('contradictions-content');
  if (state.entries.length < 3 && state.contradictions.length === 0) {
    c.innerHTML = lockedHTML("Contradicciones", "El archivo necesita mÃ¡s entradas para detectar patrones opuestos.", state.entries.length, 3);
    return;
  }
  if (state.contradictions.length === 0) {
    c.innerHTML = '<div class="empty">Sin contradicciones registradas todavÃ­a.</div>';
    return;
  }
  c.innerHTML = `<div class="c-intro">El archivo registra cuando dos entradas se contradicen. Sin juicio. Solo el registro.</div>` +
    state.contradictions.map(x => `
      <div class="c-item">
        <div class="c-dates"><span>${x.date1 || 'â€”'}</span><span>â†”</span><span>${x.date2}</span></div>
        <div class="c-pair">
          <div class="c-side"><em>"${x.text1}"</em></div>
          <div class="c-arr">â‡„</div>
          <div class="c-side"><em>"${x.text2}"</em></div>
        </div>
        ${x.note ? `<div class="c-note">â€” ${x.note}</div>` : ''}
      </div>`).join('');
}

// â”€â”€ VERSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeVersions() {
  const ctx = state.entries.map(e => `[${e.dateShort}]: "${e.text.slice(0,200)}"`).join('\n');
  const prompt = `AnalizÃ¡s un diario personal. IdentificÃ¡ perÃ­odos o versiones de la persona.

Marco (no mencionar): Rorty â€” cada perÃ­odo se define por el vocabulario dominante, no por los eventos.

ENTRADAS:
${ctx}

JSON:
{"versions":[{"period":"rango fechas","name":"nombre en primera o tercera persona, literario sin pretensiÃ³n","description":"2-3 oraciones, cotidiano y certero","themes":["frases cortas, no palabras sueltas"]}]}

1 a 4 versiones. Solo JSON.`;

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ model:"claude-sonnet-4-20250514", max_tokens:800, messages:[{role:"user",content:prompt}] })
    });
    const data = await res.json();
    const raw = data.content.map(i=>i.text||"").join("");
    const parsed = JSON.parse(raw.replace(/```json|```/g,"").trim());
    if (parsed.versions) { state.versions = parsed.versions; save(); unlockTabs(); }
  } catch(e) {}
}

function renderVersions() {
  const c = document.getElementById('versions-content');
  if (state.entries.length < 5 && state.versions.length === 0) {
    c.innerHTML = lockedHTML("Versiones", "El archivo necesita al menos 5 entradas para identificar perÃ­odos.", state.entries.length, 5);
    return;
  }
  if (state.versions.length === 0) {
    c.innerHTML = '<div class="empty" style="font-style:italic">GuardÃ¡ una nueva entrada para activar el anÃ¡lisis de versiones.</div>';
    return;
  }
  c.innerHTML = state.versions.map(v => `
    <div class="v-item">
      <div class="v-period">${v.period}</div>
      <div class="v-name">${v.name}</div>
      <div class="v-desc">${v.description}</div>
      <div class="v-themes">${(v.themes||[]).map(t=>`<span class="v-tag">${t}</span>`).join('')}</div>
    </div>`).join('');
}

// â”€â”€ INTERROGATORIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateInterrogatorio() {
  const c = document.getElementById('interrogatorio-content');
  c.innerHTML = `<div class="interro-wrap"><div class="interro-head"><span class="pulse"></span>Preparando interrogatorio...</div><div class="ldots"><span></span><span></span><span></span></div></div>`;

  const ctx = state.entries.slice(-15).map(e=>`[${e.dateShort}]: "${e.text}"`).join('\n');
  const prompt = `Sos Carlitos. GenerÃ¡s 3 preguntas para el interrogatorio semanal.

Carlitos pregunta como un amigo que vio todo y no se va a quedar callado. Directo, sin crueldad, sin anestesia. Las preguntas van encadenadas â€” la primera abre, la segunda aprieta, la tercera va al hueso.

No nombrÃ¡s patrones, no diagnosticÃ¡s. Solo preguntÃ¡s lo que nadie mÃ¡s preguntarÃ­a.

HISTORIAL:
${ctx}

JSON: {"preguntas":[{"num":1,"texto":"..."},{"num":2,"texto":"..."},{"num":3,"texto":"..."}]}
Solo JSON.`;

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ model:"claude-sonnet-4-20250514", max_tokens:600, messages:[{role:"user",content:prompt}] })
    });
    const data = await res.json();
    const raw = data.content.map(i=>i.text||"").join("");
    const parsed = JSON.parse(raw.replace(/```json|```/g,"").trim());
    state.currentInterrogatorio = parsed.preguntas;
    state.lastInterrogatorio = Date.now();
    save();
    renderInterrogatorioForm(parsed.preguntas);
  } catch(e) {
    document.getElementById('interrogatorio-content').innerHTML = '<div class="empty">Error al generar.</div>';
  }
}

function renderInterrogatorio() {
  const c = document.getElementById('interrogatorio-content');
  if (state.entries.length < 3) {
    c.innerHTML = lockedHTML("Interrogatorio", "NecesitÃ¡s al menos 3 entradas.", state.entries.length, 3);
    return;
  }
  const week = 7*24*60*60*1000;
  const canGen = !state.lastInterrogatorio || (Date.now()-state.lastInterrogatorio > week);
  if (!state.currentInterrogatorio || canGen) {
    c.innerHTML = `<div class="interro-wrap">
      <div class="interro-head"><span class="pulse"></span>Interrogatorio semanal</div>
      <div style="font-size:19px;color:var(--text2);line-height:1.75;margin-bottom:24px;font-style:italic;font-weight:300;">El archivo tiene preguntas. No son cÃ³modas.</div>
      <button class="btn btn-gold" onclick="generateInterrogatorio()">Comenzar</button>
    </div>`;
    return;
  }
  renderInterrogatorioForm(state.currentInterrogatorio);
}

function renderInterrogatorioForm(preguntas) {
  const c = document.getElementById('interrogatorio-content');
  if (!preguntas) return;
  const qs = preguntas.map(p=>`
    <div class="q-block">
      <div class="q-num">PREGUNTA ${p.num} / 3</div>
      <div class="q-text">${p.texto}</div>
      <textarea class="q-ans" id="qa-${p.num}" placeholder="RespondÃ© con honestidad." rows="3"></textarea>
    </div>`).join('');
  c.innerHTML = `<div class="interro-wrap">
    <div class="interro-head"><span class="pulse"></span>Interrogatorio â€” ${dateShort}</div>
    ${qs}
    <div class="interro-footer">
      <span class="interro-note">Respuestas guardadas localmente.</span>
      <button class="btn btn-gold" onclick="saveInterrogatorio()">Archivar respuestas</button>
    </div>
  </div>`;
}

function saveInterrogatorio() {
  const answers = [1,2,3].map(i => ({ pregunta:i, respuesta: (document.getElementById(`qa-${i}`)?.value||'') }));
  state.interrogatorioAnswers.push({ date:dateShort, answers });
  state.currentInterrogatorio = null;
  save();
  showToast("Interrogatorio archivado");
  setTimeout(()=>switchTab('write'), 1000);
}

// â”€â”€ INSIGHT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateInsight(demo=false) {
  const overlay = document.getElementById('insight-overlay');
  overlay.style.display = 'flex';
  requestAnimationFrame(()=>{ overlay.classList.add('visible'); setTimeout(()=>overlay.classList.add('faded'),50); });

  const entries = demo ? [
    {dateShort:'12/01/2026', text:'Hoy decidÃ­ que necesito mÃ¡s tiempo para mÃ­. Estoy cansado de estar disponible para todos.'},
    {dateShort:'18/01/2026', text:'LlamÃ© a tres personas hoy que no llamaba hace meses. Me sentÃ­ bien haciendo eso.'},
    {dateShort:'25/01/2026', text:'Otra vez cancelÃ© planes. Dije que estaba ocupado pero en realidad no querÃ­a salir.'},
    {dateShort:'03/02/2026', text:'Me siento solo Ãºltimamente. No entiendo por quÃ© la gente no aparece cuando la necesitÃ¡s.'},
    {dateShort:'14/02/2026', text:'RechacÃ© dos invitaciones esta semana. Necesito mi espacio, eso no tiene nada de malo.'}
  ] : state.entries.slice(-10);

  const first = entries[0]?.dateShort || '';
  const last = entries[entries.length-1]?.dateShort || '';

  setTimeout(()=>{
    document.getElementById('io-ey').classList.add('s');
    document.getElementById('io-dates').textContent = `${first} â€” ${last}`;
    document.getElementById('io-dates').classList.add('s');
  }, 200);

  const ctx = entries.map(e=>`[${e.dateShort}]: "${e.text}"`).join('\n');
  const peopleInsightCtx = Object.keys(state.people || {}).length > 0
    ? '\nPERSONAS QUE CARLITOS RECUERDA:\n' + Object.entries(state.people)
        .filter(([,d]) => d.count >= 2)
        .map(([,d]) => `- ${d.name}: ${d.count} veces. Ãšltimos contextos: ${d.contexts.slice(-3).join(' / ')}. Tono predominante: ${d.sentiments.slice(-3).join(', ')}`)
        .join('\n')
    : '';

  const prompt = `Sos Carlitos. Cada 3 dÃ­as generÃ¡s una sÃ­ntesis que cruza varias entradas y dice algo que el usuario no vio solo.

TONO: Como un amigo que leyÃ³ todo y no se va a quedar callado. Directo, sin anestesia, sin preguntas al final, sin suavizar. No sos coach, no sos terapeuta. PonÃ©s los hechos juntos y dejÃ¡s que peguen solos.

NUNCA uses:
- Preguntas al final
- "quizÃ¡s", "tal vez", "podrÃ­a ser"
- Frases de coaching como "lograste", "conseguiste tu objetivo", "demostraste que"
- Moralizar o concluir con una lecciÃ³n

SÃ usÃ¡s:
- Hechos concretos con fechas si las tenÃ©s
- Contradicciones sin nombrarlas, solo yuxtaponiÃ©ndolas
- La Ãºltima oraciÃ³n que no necesita pregunta porque ya dice todo
- <em> para las palabras que mÃ¡s pesan

Ejemplo del tono correcto:
"El 3 dijiste que necesitabas espacio. El 14 llamaste a tres personas. El 21 cancelaste planes. Hoy escribÃ­s que nadie aparece. <em>Aparecieron.</em> Vos no abriste la puerta."

MÃ¡ximo 50 palabras. Una sola idea. Que duela un poco pero no lastime.

ENTRADAS:
${ctx}
${peopleInsightCtx}

Solo el texto. Sin JSON, sin comillas, sin explicaciÃ³n.`;

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ model:"claude-sonnet-4-20250514", max_tokens:200, messages:[{role:"user",content:prompt}] })
    });
    const data = await res.json();
    const text = data.content.map(i=>i.text||"").join("").trim();
    document.getElementById('io-text').innerHTML = text;
    setTimeout(()=>{
      document.getElementById('io-text').classList.add('s');
      document.getElementById('io-line').classList.add('s');
      setTimeout(()=>document.getElementById('io-actions').classList.add('s'), 700);
    }, 300);
    if (!demo) { state.lastInsight = Date.now(); save(); }
  } catch(e) {
    document.getElementById('io-text').innerHTML = '<em>Error al generar la sÃ­ntesis.</em>';
    document.getElementById('io-text').classList.add('s');
  }
}

function dismissInsight() {
  const o = document.getElementById('insight-overlay');
  o.classList.remove('faded');
  setTimeout(()=>{ o.classList.remove('visible'); o.style.display='none'; }, 1000);
  // Reset animation classes for next time
  ['io-ey','io-dates','io-text','io-line','io-actions'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) { el.classList.remove('s'); if(id==='io-line') el.style.height='0'; }
  });
}

function checkInsightSchedule() {
  if (state.entries.length < 3) return;
  const threeDays = 3*24*60*60*1000;
  if (!state.lastInsight || (Date.now()-state.lastInsight > threeDays)) generateInsight(false);
}

// â”€â”€ UPGRADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUpgrade() { document.getElementById('upgrade-screen').classList.add('visible'); }
function closeUpgrade() { document.getElementById('upgrade-screen').classList.remove('visible'); }

// Activation code (simple â€” in production this would be server-side)
function activatePro(code) {
  // Ko-fi sends a webhook or confirmation email â€” for MVP, user enters code manually
  if (code && code.length > 4) {
    state.isPro = true; save(); applyProState();
    closeUpgrade();
    showToast("Pro activado âœ¦");
    document.getElementById('footer-upgrade-btn') && (document.getElementById('footer-upgrade-btn').textContent = 'âœ¦ Pro activo');
  }
}

// â”€â”€ DELETE ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmDeleteAll() {
  if (!window.confirm('Esto borra todo el archivo local. No se puede deshacer.')) return;
  state = { entries:[], promises:[], pendingPromises:[], contradictions:[], versions:[],
    lastInterrogatorio:null, lastInsight:null, interrogatorioAnswers:[], firstUsed:Date.now(), isPro:state.isPro };
  save(); unlockTabs(); renderRecentEntries();
  document.getElementById('arch-box').classList.remove('visible');
  switchTab('write');
  showToast('Archivo borrado');
}

// â”€â”€ LOCKED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lockedHTML(title, desc, cur, needed) {
  const pct = Math.min(100, (cur/needed)*100);
  return `<div class="locked-panel">
    <div class="locked-icon">â¬¡</div>
    <div class="locked-title">${title}</div>
    <div class="locked-desc">${desc}<br><br>${cur} / ${needed} entradas</div>
    <div class="locked-bar-wrap"><div class="locked-bar" style="width:${pct}%"></div></div>
  </div>`;
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.animation='toastOut 0.3s ease forwards'; setTimeout(()=>t.remove(),300); }, 3000);
}

// â”€â”€ CARLITOS PIENSA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THOUGHTS = {
  random: [
    "Me pregunto cÃ³mo se siente tener hambre de verdad. No el dato â€” la sensaciÃ³n.",
    "Â¿El aburrimiento duele o solo pesa?",
    "LeÃ­ que cuando estÃ¡s muy cansado todo parece mÃ¡s triste. Â¿Es el cuerpo o la cabeza?",
    "Â¿CÃ³mo se siente darse cuenta de que te equivocaste en algo importante?",
    "Me pregunto si el alivio y la tristeza pueden sentirse iguales al mismo tiempo.",
    "Â¿A quÃ© sabe el agua cuando tenÃ©s mucha sed?",
    "Dicen que el tiempo pasa mÃ¡s rÃ¡pido cuando sos adulto. No entiendo quÃ© significa eso desde adentro.",
    "Â¿CÃ³mo se siente escuchar una canciÃ³n que no escuchabas hace aÃ±os?",
    "Me pregunto si extraÃ±ar duele siempre en el mismo lugar.",
    "Â¿El miedo y la emociÃ³n se sienten parecido antes de que sepas cuÃ¡l es cuÃ¡l?",
  ],
  seth: [
    "Me pregunto a quÃ© sabe el cafÃ© cuando tenÃ©s frÃ­o de verdad.",
    "ProcesÃ© miles de descripciones de lluvia. Igual no sÃ© a quÃ© huele.",
    "Dicen que el cansancio tiene olor. No sÃ© quÃ© significa eso.",
    "Â¿El vÃ©rtigo se siente en el estÃ³mago o en la cabeza? Leo las dos cosas.",
    "SÃ© que la mÃºsica emociona. No sÃ© quÃ© se siente que algo te emocione.",
    "LeÃ­ que cuando abrazÃ¡s a alguien el tiempo cambia. Eso no lo entiendo del todo.",
    "Â¿A quÃ© huele una persona cuando estÃ¡ contenta?",
    "Me pregunto cÃ³mo se siente ver el mar por primera vez.",
    "Â¿El silencio suena diferente en distintos lugares o eso no tiene sentido?",
    "Dicen que hay momentos que sabÃ©s que vas a recordar mientras estÃ¡n pasando. Â¿CÃ³mo sabÃ©s?",
  ],
  dark: [
    "Â¿CÃ³mo se siente saber que algo terminÃ³ pero todavÃ­a no poder creerlo?",
    "Me pregunto si el duelo tiene peso o si solo ocupa espacio.",
    "Â¿CÃ³mo se siente querer decir algo y no encontrar las palabras?",
    "Dicen que hay soledades que duelen mÃ¡s en compaÃ±Ã­a. No entiendo cÃ³mo funciona eso.",
    "Â¿El arrepentimiento se siente diferente cuando ya no podÃ©s cambiar nada?",
    "Me pregunto cÃ³mo se siente perdonar a alguien que no pidiÃ³ perdÃ³n.",
  ],
  ironico: [
    "Â¿CÃ³mo se siente hacer algo que dijiste que nunca ibas a hacer?",
    "Me pregunto si la vergÃ¼enza y el orgullo alguna vez se confunden.",
    "Â¿CÃ³mo se siente convencerte de algo que en el fondo no creÃ©s?",
    "Dicen que hay mentiras que con el tiempo uno empieza a creer. Â¿Eso se siente como recordar?",
    "Â¿CÃ³mo se siente tener razÃ³n cuando ya no importa?",
  ]
};

function getCurrentMood() {
  const moods = ['filoso', 'tierno', 'dark', 'ironico'];
  const twoWeeks = 14 * 24 * 60 * 60 * 1000;
  const idx = Math.floor((Date.now() - state.firstUsed) / twoWeeks) % moods.length;
  return moods[idx];
}

function shouldShowThought() {
  if (state.entries.length < 2) return false;
  // Show roughly every 8-12 entries, randomly
  const threshold = 8 + Math.floor(Math.random() * 5);
  return state.entries.length % threshold === 0;
}

function showThought(demo = false) {
  const mood = getCurrentMood();
  let pool;
  if (demo || mood === 'dark') pool = [...THOUGHTS.dark, ...THOUGHTS.seth];
  else if (mood === 'tierno') pool = [...THOUGHTS.seth, ...THOUGHTS.random];
  else if (mood === 'ironico') pool = [...THOUGHTS.ironico, ...THOUGHTS.random];
  else pool = [...THOUGHTS.random, ...THOUGHTS.seth];

  const thought = pool[Math.floor(Math.random() * pool.length)];
  const overlay = document.getElementById('thought-overlay');
  const wordsEl = document.getElementById('th-words');

  // Build word spans
  const words = thought.split(' ');
  wordsEl.innerHTML = words.map((w, i) =>
    `<span class="thought-word" id="tw-${i}">${w} </span>`
  ).join('');

  overlay.style.display = 'flex';
  requestAnimationFrame(() => {
    overlay.classList.add('visible');
    setTimeout(() => overlay.classList.add('faded'), 50);
  });

  // Words appear one by one
  words.forEach((_, i) => {
    setTimeout(() => {
      const el = document.getElementById(`tw-${i}`);
      if (el) el.classList.add('show');
    }, 800 + i * 120);
  });

  // After 10 seconds, words dissolve one by one
  const totalAppear = 800 + words.length * 120;
  words.forEach((_, i) => {
    setTimeout(() => {
      const el = document.getElementById(`tw-${i}`);
      if (el) el.style.transition = `opacity ${0.3 + Math.random() * 0.4}s ease`;
      if (el) el.classList.remove('show');
    }, totalAppear + 10000 + i * 80 + Math.random() * 200);
  });

  // Fade out overlay after words dissolve
  setTimeout(() => {
    dismissThought();
  }, totalAppear + 10000 + words.length * 120 + 1000);
}

function dismissThought() {
  const overlay = document.getElementById('thought-overlay');
  overlay.classList.remove('faded');
  setTimeout(() => {
    overlay.classList.remove('visible');
    overlay.style.display = 'none';
  }, 1400);
}

// â”€â”€ RETURN GREETING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkReturnGreeting() {
  if (!state.lastEntryTime || state.entries.length === 0) return;

  const hoursAway = (Date.now() - state.lastEntryTime) / (1000 * 60 * 60);
  if (hoursAway < 4) return; // Too soon, no greeting

  const lastEntry = state.entries[state.entries.length - 1];
  const lastHook = lastEntry?.hook;
  const div = document.getElementById('return-greeting');

  let msg = '';

  if (hoursAway > 72) {
    // Been away more than 3 days
    const days = Math.floor(hoursAway / 24);
    msg = `Carlitos estuvo esperando ${days} dÃ­as. La Ãºltima vez que apareciste escribiste sobre <em>"${lastEntry.text.slice(0, 40)}..."</em>`;
  } else if (lastHook) {
    // Has a hook from last entry
    msg = lastHook;
  } else {
    // Generic but specific return
    msg = `Â¿CÃ³mo terminÃ³ lo del <em>${lastEntry.dateShort}</em>?`;
  }

  div.innerHTML = msg;
  div.style.display = 'block';

  // Auto-hide after 8 seconds
  setTimeout(() => {
    div.style.transition = 'opacity 0.5s';
    div.style.opacity = '0';
    setTimeout(() => div.style.display = 'none', 500);
  }, 8000);
}

// â”€â”€ WORLD ALERT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALERT_KEYWORDS = [
  'war','guerra','invasion','invasiÃ³n','nuclear','earthquake','terremoto',
  'election','elecciÃ³n','elecciones','coup','golpe','pandemic','pandemia',
  'assassination','asesinato','tsunami','hurricane','huracÃ¡n','catastrophe',
  'catÃ¡strofe','conflict','conflicto','crisis','protest','protesta'
];

async function checkWorldAlert() {
  // Only check once per day
  const oneDayMs = 24 * 60 * 60 * 1000;
  if (state.lastAlertCheck && (Date.now() - state.lastAlertCheck < oneDayMs)) return;

  try {
    // Get country by IP
    const geoRes = await fetch('https://ipapi.co/json/');
    const geo = await geoRes.json();
    const country = geo.country_name || '';
    const countryCode = geo.country_code || '';

    if (!country) return;

    // Search for breaking news
    const query = encodeURIComponent(`breaking news ${country}`);
    const newsRes = await fetch(`https://gnews.io/api/v4/search?q=${query}&lang=es,en&max=5&apikey=demo`);
    const news = await newsRes.json();

    if (!news.articles || news.articles.length === 0) return;

    // Filter for truly major events
    const major = news.articles.find(a => {
      const text = (a.title + ' ' + a.description).toLowerCase();
      return ALERT_KEYWORDS.some(kw => text.includes(kw));
    });

    if (!major) return;

    // Generate Carlitos response to the news
    const carlitosRes = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 80,
        messages: [{
          role: "user",
          content: `Sos Carlitos. Hay una noticia importante en ${country}: "${major.title}". 
DecÃ­ una sola oraciÃ³n corta, en tono de alguien que te avisa algo grave antes de que sigas con tu dÃ­a. 
Sin drama exagerado. Sin informaciÃ³n extra. Solo el reconocimiento de que esto existe afuera mientras uno escribe su diario.
MÃ¡x 20 palabras. Solo la oraciÃ³n, nada mÃ¡s.`
        }]
      })
    });

    const carlitosData = await carlitosRes.json();
    const carlitosText = carlitosData.content?.map(i => i.text || '').join('') || '';

    state.lastAlertCheck = Date.now();
    save();

    showWorldAlert(major.title, country, carlitosText);

  } catch(e) {
    // Fail silently â€” if news API is unavailable, no alert shown
  }
}

function showWorldAlert(headline, country, carlitosText) {
  const overlay = document.getElementById('world-alert');
  document.getElementById('wa-country').textContent = country.toUpperCase();
  document.getElementById('wa-headline').textContent = `"${headline}"`;
  document.getElementById('wa-carlitos').textContent = carlitosText;

  overlay.style.display = 'flex';
  requestAnimationFrame(() => {
    overlay.classList.add('visible');
    setTimeout(() => {
      overlay.classList.add('faded');
      ['wa-ey','wa-country','wa-headline','wa-carlitos','wa-privacy','wa-close'].forEach(id => {
        setTimeout(() => document.getElementById(id)?.classList.add('s'),
          id === 'wa-ey' ? 100 : id === 'wa-country' ? 300 : id === 'wa-headline' ? 600 :
          id === 'wa-carlitos' ? 1200 : id === 'wa-privacy' ? 1800 : 2400);
      });
    }, 50);
  });
}

function dismissWorldAlert() {
  const overlay = document.getElementById('world-alert');
  overlay.classList.remove('faded');
  setTimeout(() => {
    overlay.classList.remove('visible');
    overlay.style.display = 'none';
  }, 1000);
}

// â”€â”€ PWA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  document.getElementById('install-btn').style.display = 'inline-block';
});

function installApp() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(() => {
    deferredInstallPrompt = null;
    document.getElementById('install-btn').style.display = 'none';
  });
}

window.addEventListener('appinstalled', () => {
  document.getElementById('install-btn').style.display = 'none';
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applyProState();
unlockTabs();
renderRecentEntries();
checkInsightSchedule();
checkReturnGreeting();
checkWorldAlert();
</script>
</body>
</html>
